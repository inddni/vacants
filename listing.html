<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listing</title>
  <meta name="description" content="Vacancy listing details." />

  <style>
    /* Theme tokens */
    :root{
      --bg: #ffffff;
      --fg: #0b0f14;
      --muted: rgba(11,15,20,.75);
      --border: rgba(127,127,127,.35);
      --border2: rgba(127,127,127,.25);
      --surface: rgba(0,0,0,.02);
      --radius: 14px;
      color-scheme: light;
    }
    html[data-theme="dark"]{
      --bg: #0b0f14;
      --fg: #e9eef5;
      --muted: rgba(233,238,245,.75);
      --border: rgba(233,238,245,.35);
      --border2: rgba(233,238,245,.25);
      --surface: rgba(255,255,255,.04);
      color-scheme: dark;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.45;
      background: var(--bg);
      color: var(--fg);
    }

    .muted{ opacity: .8; }

    header{
      padding: 18px 16px;
      border-bottom: 1px solid var(--border);
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap: wrap;
    }
    header a{ text-decoration:none; color: inherit; }
    header a:hover{ text-decoration: underline; }

    main{ padding: 16px; max-width: 1000px; margin: 0 auto; }

    h1{ margin: 10px 0 6px; font-size: 22px; }

    .notice{
      margin: 12px 0;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
    }
    .error{ border-color: rgba(220,60,60,.6); }

    .grid{
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      margin-top: 12px;
    }
    .card{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      background: var(--surface);
    }
    .kv{ display:grid; gap:6px; }
    .k{ font-size: 12px; opacity: .75; }
    .v{ font-size: 15px; }

    .gallery{
      display:grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      margin-top: 12px;
    }
    .gallery img{
      width: 100%;
      height: auto;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--surface);
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .btn{
      display:inline-block;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
      text-decoration:none;
      color: inherit;
    }
    .btn:hover{ text-decoration: underline; }

    /* Toggle */
    .theme-toggle{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:var(--surface);
    }
    .theme-toggle span{ font-size:12px; opacity:.85; }

    .switch{
      position:relative;
      width:46px;
      height:26px;
      border-radius:999px;
      border:1px solid var(--border);
      flex: 0 0 auto;
    }
    .switch input{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
    }
    .knob{
      position:absolute;
      top:3px;
      left:3px;
      width:20px;
      height:20px;
      border-radius:999px;
      background:currentColor;
      opacity:.85;
      transition:transform .18s ease;
    }
    .switch input:checked + .knob{ transform:translateX(20px); }

    /* Simple focus */
    .switch input:focus-visible + .knob{
      outline: 2px solid currentColor;
      outline-offset: 2px;
    }

    .sr-only{
      position:absolute;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
    }
  </style>

  <script>
    (function () {
      const saved = localStorage.getItem("ivb_theme");
      if (saved === "light" || saved === "dark") {
        document.documentElement.setAttribute("data-theme", saved);
      } else {
        const prefersDark =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
        document.documentElement.setAttribute("data-theme", prefersDark ? "dark" : "light");
      }
    })();
  </script>
</head>

<body>
  <header>
    <a href="./index.html">← Back to listings</a>
    <span class="muted">Inland Vacancy Board</span>

    <div class="theme-toggle">
      <span>Theme</span>
      <label class="switch">
        <span class="sr-only">Toggle dark mode</span>
        <input id="themeSwitch" type="checkbox" aria-label="Toggle dark mode" />
        <span class="knob" aria-hidden="true"></span>
      </label>
    </div>
  </header>

  <main>
    <div class="notice">
      <strong>Information only.</strong> Verify all details independently.
    </div>

    <div id="state" class="notice">Loading listing…</div>

    <section id="content" hidden>
      <p class="muted" id="meta"></p>
      <h1 id="title"></h1>

      <div class="actions" id="actions"></div>

      <div class="grid" id="basics"></div>

      <h2 style="margin-top:18px; font-size:18px;">Photos</h2>
      <div class="gallery" id="gallery"></div>
    </section>
  </main>

  <script>
    const CSV_PATH = "./resources/listings.csv";

    const qs = new URLSearchParams(location.search);
    const listingId = qs.get("id");
    const DEFAULT_OFFICE_PHONE = "9096253259";

    const els = {
      state: document.getElementById("state"),
      content: document.getElementById("content"),
      title: document.getElementById("title"),
      meta: document.getElementById("meta"),
      basics: document.getElementById("basics"),
      gallery: document.getElementById("gallery"),
      actions: document.getElementById("actions"),
    };

    // Theme toggle wiring
    (function () {
      const sw = document.getElementById("themeSwitch");
      if (!sw) return;

      const current = document.documentElement.getAttribute("data-theme");
      sw.checked = current === "dark";

      sw.addEventListener("change", () => {
        const next = sw.checked ? "dark" : "light";
        document.documentElement.setAttribute("data-theme", next);
        localStorage.setItem("ivb_theme", next);
      });
    })();

    function parseCSV(csvText) {
      const rows = [];
      let row = [];
      let field = "";
      let inQuotes = false;

      for (let i = 0; i < csvText.length; i++) {
        const c = csvText[i];
        const next = csvText[i + 1];

        if (inQuotes) {
          if (c === '"' && next === '"') { field += '"'; i++; continue; }
          if (c === '"') { inQuotes = false; continue; }
          field += c;
          continue;
        }

        if (c === '"') { inQuotes = true; continue; }
        if (c === ",") { row.push(field); field = ""; continue; }
        if (c === "\n") { row.push(field); rows.push(row); row = []; field = ""; continue; }
        if (c === "\r") { continue; }
        field += c;
      }
      if (field.length || row.length) { row.push(field); rows.push(row); }
      while (rows.length && rows[rows.length - 1].every(v => !String(v).trim())) rows.pop();

      if (!rows.length) return [];
      const headers = rows[0].map(h => h.trim());
      const data = [];
      for (let r = 1; r < rows.length; r++) {
        const obj = {};
        for (let c = 0; c < headers.length; c++) obj[headers[c]] = (rows[r][c] ?? "").trim();
        data.push(obj);
      }
      return data;
    }

    function money(v) {
      if (v === "" || v == null) return "—";
      const n = Number(String(v).replace(/[^\d.]/g, ""));
      if (!Number.isFinite(n)) return "—";
      return n.toLocaleString(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 0 });
    }

    function textOrDash(v) {
      const s = (v ?? "").toString().trim();
      return s ? s : "—";
    }

    function buildAddress(item) {
      const a1 = (item.address_line1 || "").trim();
      const a2 = (item.address_line2 || "").trim();
      const city = (item.city || "").trim();
      const parts = [a1, a2].filter(Boolean).join(", ");
      return [parts, city].filter(Boolean).join(" — ");
    }

    function splitPhotos(photosField) {
      // Accept semicolon OR comma separated URLs
      const raw = (photosField || "").trim();
      if (!raw) return [];
      const parts = raw.includes(";") ? raw.split(";") : raw.split(",");
      return parts.map(s => s.trim()).filter(Boolean);
    }

    function addKV(container, k, v) {
      const card = document.createElement("div");
      card.className = "card kv";

      const dk = document.createElement("div");
      dk.className = "k";
      dk.textContent = k;

      const dv = document.createElement("div");
      dv.className = "v";
      dv.textContent = v;

      card.append(dk, dv);
      container.appendChild(card);
    }

    function addActionLink(label, href) {
      if (!href) return;
      const a = document.createElement("a");
      a.className = "btn";
      a.href = href;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      a.textContent = label;
      els.actions.appendChild(a);
    }

    async function main() {
      try {
        if (!listingId) {
          els.state.classList.add("error");
          els.state.textContent = "Missing listing id. Open a listing from the main page.";
          return;
        }

        const res = await fetch(CSV_PATH, { cache: "no-store" });
        if (!res.ok) throw new Error(`Failed to load CSV (${res.status})`);
        const text = await res.text();

        const all = parseCSV(text);
        const item = all.find(r => (r.listing_id || "") === listingId);

        if (!item) {
          els.state.classList.add("error");
          els.state.textContent = `Listing not found for id: ${listingId}`;
          return;
        }

        // Title/meta
        document.title = `${buildAddress(item)} | Inland Vacancy Board`;
        els.title.textContent = buildAddress(item);
        els.meta.textContent = `ID: ${textOrDash(item.listing_id)} • Status: ${textOrDash(item.status)} • Updated: ${textOrDash(item.updated_at)}`;

        // Action links
        addActionLink("Listing link", (item.listing_url || "").trim());

        // Photos: handle single vs multiple URLs gracefully
        const photos = splitPhotos(item.photos_url);
        if (photos.length === 1) {
          addActionLink("Photo", photos[0]);
        } else if (photos.length > 1) {
          addActionLink("First photo", photos[0]);
        }

        if ((item.contact_email || "").trim()) addActionLink("Email", `mailto:${item.contact_email.trim()}`);

        const callNumber = (item.contact_phone || "").trim() || DEFAULT_OFFICE_PHONE;
        addActionLink("Call", `tel:${callNumber}`);

        // Basics cards
        addKV(els.basics, "Rent", money(item.rent_usd));
        addKV(els.basics, "Deposit", money(item.deposit_usd));
        addKV(els.basics, "Beds", textOrDash(item.beds));
        addKV(els.basics, "Baths", textOrDash(item.baths));
        addKV(els.basics, "Sqft", textOrDash(item.sqft));
        addKV(els.basics, "Available", textOrDash(item.available_date));
        addKV(els.basics, "Lease term (months)", textOrDash(item.lease_term_months));
        addKV(els.basics, "Property type", textOrDash(item.property_type));
        addKV(els.basics, "Pets", textOrDash(item.pet_policy));
        addKV(els.basics, "Parking", textOrDash(item.parking));
        addKV(els.basics, "Utilities included", textOrDash(item.utilities_included));

        const phone = (item.contact_phone || "").trim() || DEFAULT_OFFICE_PHONE;
        const contactLabel = [(item.contact_name || "").trim(), phone].filter(Boolean).join(" • ");
        addKV(els.basics, "Contact", contactLabel);

        // Photo gallery
        if (!photos.length) {
          const p = document.createElement("p");
          p.className = "muted";
          p.textContent = "No photo URLs provided.";
          els.gallery.appendChild(p);
        } else {
          for (const url of photos) {
            const img = document.createElement("img");
            img.loading = "lazy";
            img.alt = `Photo for ${item.listing_id}`;
            img.src = url;
            els.gallery.appendChild(img);
          }
        }

        els.state.remove();
        els.content.hidden = false;

      } catch (err) {
        els.state.classList.add("error");
        els.state.textContent = `Error: ${err.message}`;
      }
    }

    main();
  </script>
</body>
</html>
